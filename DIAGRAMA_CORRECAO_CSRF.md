# ๐ DIAGRAMA VISUAL: Correรงรฃo do Erro 403 CSRF

## ๐ด ANTES (Com Erro 403)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    NAVEGADOR DO USUรRIO                         โ
โ                   (https://seu-dominio)                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ HTTPS (1. GET /login/)
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  HEROKU (Proxy Reverso)                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ X-Forwarded-Proto: https                                  โ โ
โ  โ X-Forwarded-For: 203.0.113.45                             โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ HTTP (Django nรฃo recebe https!)
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               DJANGO (Em desenvolvimento)                        โ
โ                                                                  โ
โ  โ SECURE_PROXY_SSL_HEADER nรฃo configurado                     โ
โ     Django pensa: "Recebi HTTP"                                 โ
โ     Cria token CSRF para: HTTP                                  โ
โ                                                                  โ
โ  2๏ธโฃ Renderiza formulรกrio com token HTTP                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ Form + CSRF Token
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    NAVEGADOR DO USUรRIO                         โ
โ                   Recebe: <form> com token                      โ
โ                   Usuรกrio preenche credenciais                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ HTTPS (3. POST /login/ + Token)
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  HEROKU (Proxy Reverso)                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ X-Forwarded-Proto: https                                  โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ HTTP (Django recebe HTTP)
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               DJANGO (Em desenvolvimento)                        โ
โ                                                                  โ
โ  โ Verifica token CSRF                                          โ
โ     Token foi criado para: HTTP                                 โ
โ     Requisiรงรฃo vem com: HTTPS                                   โ
โ                                                                  โ
โ  ๐ด TOKEN MISMATCH!                                              โ
โ     CSRF verification failed                                    โ
โ     Request aborted                                             โ
โ     HTTP/1.1 403 Forbidden                                      โ
โ                                                                  โ
โ  Usuรกrio vรช: ERRO 403 CSRF                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ข DEPOIS (Corrigido)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    NAVEGADOR DO USUรRIO                         โ
โ                   (https://seu-dominio)                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ HTTPS (1. GET /login/)
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  HEROKU (Proxy Reverso)                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ X-Forwarded-Proto: https        โ Django lรช isso!        โ โ
โ  โ X-Forwarded-For: 203.0.113.45                             โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ HTTP (mas Django sabe que รฉ HTTPS)
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               DJANGO (Em produรงรฃo)                               โ
โ                                                                  โ
โ  โ SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
โ     Django lรช header: "X-Forwarded-Proto: https"               โ
โ     Interpreta como: "Recebi HTTPS"                            โ
โ     Cria token CSRF para: HTTPS                                โ
โ                                                                  โ
โ  2๏ธโฃ Renderiza formulรกrio com token HTTPS                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ Form + CSRF Token
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    NAVEGADOR DO USUรRIO                         โ
โ                   Recebe: <form> com token                      โ
โ                   Usuรกrio preenche credenciais                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ HTTPS (3. POST /login/ + Token)
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  HEROKU (Proxy Reverso)                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ X-Forwarded-Proto: https                                  โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ HTTP (mas Django sabe que รฉ HTTPS)
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               DJANGO (Em produรงรฃo)                               โ
โ                                                                  โ
โ  โ Verifica token CSRF                                          โ
โ     Token foi criado para: HTTPS                               โ
โ     Requisiรงรฃo vem com: HTTPS                                  โ
โ                                                                  โ
โ  โ TOKEN MATCH!                                                โ
โ     CSRF verification successful                               โ
โ     Autentica usuรกrio                                          โ
โ     HTTP/1.1 302 Found                                         โ
โ     Location: /dashboard/                                      โ
โ                                                                  โ
โ  Usuรกrio vรช: REDIRECIONADO PARA DASHBOARD                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ Redireciona para dashboard
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    NAVEGADOR DO USUรRIO                         โ
โ                   (https://seu-dominio/dashboard/)              โ
โ                      โ LOGIN OK!                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ง Configuraรงรตes Adicionadas

### Antes
```python
# โ FALTAVA ISTO:
SECURE_PROXY_SSL_HEADER = ???
CSRF_TRUSTED_ORIGINS = ???
```

### Depois
```python
# โ ADICIONADO:
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
CSRF_TRUSTED_ORIGINS = config(
    'CSRF_TRUSTED_ORIGINS',
    default='https://seu-dominio.herokuapp.com',
    cast=Csv()
)
CSRF_COOKIE_SAMESITE = 'Lax'
```

### Variรกveis de Ambiente (Heroku)
```bash
# โ NOVAS VARIรVEIS:
ALLOWED_HOSTS=localhost,127.0.0.1,seu-dominio.herokuapp.com
CSRF_TRUSTED_ORIGINS=https://seu-dominio.herokuapp.com
DEBUG=False
SECURE_SSL_REDIRECT=True
CSRF_COOKIE_SECURE=True
SESSION_COOKIE_SECURE=True
```

---

## ๐ Fluxo de Requisiรงรฃo (Sequรชncia)

### GET /login/
```
1. Cliente                โ Heroku HTTPS
2. Heroku (Proxy)         โ Django HTTP (com headers)
3. Django                 โ Lรช X-Forwarded-Proto: https
4. Django                 โ Cria token CSRF para HTTPS
5. Django                 โ Renderiza template
6. Heroku (Proxy)         โ Devolve ao cliente HTTPS
7. Cliente                โ Recebe HTML com token HTTPS
```

### POST /login/
```
1. Cliente                โ Envia POST HTTPS + token
2. Heroku (Proxy)         โ Redireciona para Django HTTP
3. Django                 โ Lรช X-Forwarded-Proto: https
4. Django                 โ Verifica token CSRF
5. Django                 โ โ Token vรกlido para HTTPS
6. Django                 โ Autentica usuรกrio
7. Django                 โ Retorna 302 Redirect
8. Heroku (Proxy)         โ Devolve Redirect HTTPS
9. Cliente                โ Segue Redirect para Dashboard
```

---

## ๐ฏ Comparaรงรฃo: Antes vs Depois

| Aspecto | Antes | Depois |
|---------|-------|--------|
| **SECURE_PROXY_SSL_HEADER** | โ Nรฃo | โ Sim |
| **CSRF_TRUSTED_ORIGINS** | โ Nรฃo | โ Sim |
| **Django pensa que รฉ HTTPS** | โ Nรฃo | โ Sim |
| **Token criado para HTTPS** | โ Nรฃo | โ Sim |
| **POST com HTTPS funciona** | โ Nรฃo | โ Sim |
| **Login bem-sucedido** | โ Erro 403 | โ OK |

---

## ๐ Resumo Tรฉcnico

**Problema:** Django rodando atrรกs de proxy reverso (Heroku) nรฃo reconhecia HTTPS

**Soluรงรฃo:** 
1. Adicionar `SECURE_PROXY_SSL_HEADER` para ler header `X-Forwarded-Proto`
2. Adicionar `CSRF_TRUSTED_ORIGINS` para permitir domรญnio Heroku
3. Configurar `CSRF_COOKIE_SAMESITE` como 'Lax' para compatibilidade

**Resultado:** Django agora reconhece corretamente HTTPS โ Token CSRF vรกlido โ Login funciona โ

---

**Documentaรงรฃo:** Ver `CORRECAO_ERRO_CSRF_403.md` para detalhes completos
