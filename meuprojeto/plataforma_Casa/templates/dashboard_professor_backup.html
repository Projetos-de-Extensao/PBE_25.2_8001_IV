<!--
    ============================================================================
    TEMPLATE: DASHBOARD - PAINEL DE CONTROLE
    ============================================================================
    
    DESCRIÇÃO:
    Painel de controle com KPIs (Key Performance Indicators) e estatísticas
    personalizadas por perfil de usuário. Exibe informações críticas para
    tomada de decisão em tempo real.
    
    FUNCIONALIDADES PRINCIPAIS:
    1. Dashboard do Professor: Vagas ativas, candidatos, monitores aprovados
    2. Dashboard Admin: Visão geral do sistema com todas as métricas globais
    3. Renderização condicional: Conteúdo diferente baseado em is_professor_dashboard
    4. Tabelas de dados: Últimas inscrições, monitorias, dados pendentes
    5. Cards com hover effects: Feedback visual ao interagir
    6. Grid layout responsivo: 3 colunas → 1 coluna em mobile
    
    SEGURANÇA & PERMISSÕES:
    - Acesso: Apenas usuários autenticados (Professor ou Admin)
    - Dados: Context variables injetadas pela view filtra dados do usuário
    - Templates condicionais: Usa is_professor_dashboard para garantir segurança
    
    VARIÁVEIS CONTEXT ESPERADAS (Professor):
    - total_minhas_vagas: int - quantidade de vagas criadas
    - total_candidatos: int - total de candidatos em todas as vagas
    - monitores_aprovados: int - total de monitores aprovados
    - candidatos_pendentes: int - inscrições não analisadas
    - horas_pendentes: int - horas de trabalho aguardando validação
    - ultimas_inscricoes: QuerySet - últimas 5-10 inscrições (ordering: -data_inscricao)
    - vagas_populares: QuerySet - vagas ordenadas por numero de candidatos
    - minhas_turmas: QuerySet - turmas do professor (status ativo)
    
    VARIÁVEIS CONTEXT ESPERADAS (Admin):
    - total_usuarios: int - quantidade de usuários registrados
    - total_alunos: int - quantidade de alunos
    - total_turmas: int - turmas ativas no sistema
    - total_vagas: int - vagas abertas
    - ultimas_monitorias: QuerySet - últimas monitorias criadas
    - inscricoes_pendentes: QuerySet - inscrições com status pendente
    
    PADRÕES DE DESIGN:
    - Card-based layout: Cada métrica em seu próprio card
    - Color coding: Cores representam tipos (amarelo=warning, azul=info, verde=success)
    - Empty states: Mensagens amigáveis quando não há dados
    - Tables responsive: <table-responsive> para scroll em mobile
    - Badge styles: Status badges com cores padronizadas
    
    PERFORMANCE:
    - Dados pré-filtrados na view (não na template)
    - Limite de registros em tabelas (últimas 5-10)
    - Grid layout com media queries para responsividade
    
    AUTOR: Equipe de Desenvolvimento
    DATA: Outubro 2025
    ============================================================================
-->
{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Plataforma Casa{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<!-- Theme Toggle Button -->
<button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
    <i class="fas fa-moon"></i>
</button>

<div class="container-fluid dashboard-container">

    <!-- 
        ========================================================================
        RENDERIZAÇÃO CONDICIONAL: DASHBOARD DO PROFESSOR vs ADMIN
        ========================================================================
        
        Este bloco renderiza conteúdo completamente diferente baseado no tipo de usuário:
        
        - is_professor_dashboard == True: Dashboard do Professor (foco em suas vagas)
        - is_professor_dashboard == False: Dashboard Admin (visão global do sistema)
        
        SEGURANÇA: Esta separação garante que professor não veja dados globais
        e admin tem visão gerencial completa.
    -->

    {% if is_professor_dashboard %}
    <!-- 
        ====================================================================
        DASHBOARD DO PROFESSOR
        ====================================================================
        
        Conteúdo específico para professores coordenadores de monitoria
        Foca em: Vagas criadas, candidatos, monitores, inscrições pendentes
        
        Permissão: is_professor_dashboard (setado na view por is_professor check)
        
        1. Total de Candidatos: Soma de candidatos em todas as vagas
        2. Monitores Aprovados: Quantos foram selecionados/aprovados
        3. Candidatos Pendentes: Inscrições aguardando análise
        4. Horas Pendentes: Horas de trabalho não validadas
        
        Tabelas:
        1. Últimas Inscrições: Últimas 10 inscrições (com status)
        2. Vagas Mais Procuradas: Ordenadas por numero de candidatos
        3. Minhas Turmas Ativas: Turmas vinculadas às monitorias
    -->

    <!-- Cabeçalho da página -->
    <div class="dashboard-header">
        <h1>
            <i class="fas fa-chart-bar"></i> Dashboard do Professor
        </h1>
        <p>
            <small><i class="fas fa-clock"></i> Painel de controle de suas vagas e inscrições</small>
        </p>
    </div>

    <!-- 
        ====================================================================
        KPIs PRINCIPAIS - GRID 3 COLUNAS
        ====================================================================
        
        Cards com métricas essenciais para professor
        Cada card exibe: Label + Número grande + Ícone
        
        Variáveis de contexto:
        - total_minhas_vagas: Contagem de vagas criadas pelo professor
        - total_candidatos: SUM de inscrições em todas as vagas do professor
        - monitores_aprovados: Contagem de monitores com status="aprovado"
    -->
    <div class="grid-dashboard">

        <!-- Card 1: Total de Candidatos -->
        <div class="dashboard-card">
            <div class="stat-item">
                <div>
                    <div class="stat-label">Total de Candidatos</div>
                    <div class="stat-number">{{ total_candidatos }}</div>
                </div>
                <div class="icon-stat"><i class="fas fa-users"></i></div>
            </div>
        </div>

        <!-- Card 2: Monitores Aprovados -->
        <div class="dashboard-card">
            <div class="stat-item">
                <div>
                    <div class="stat-label">Monitores Aprovados</div>
                    <div class="stat-number">{{ monitores_aprovados }}</div>
                </div>
                <div class="icon-stat"><i class="fas fa-check-circle"></i></div>
            </div>
        </div>
    </div>

    <!-- 
        ====================================================================
        ALERTAS PENDENTES - GRID 2 COLUNAS
        ====================================================================
        
        Destaques para itens que requerem ação do professor
        Usa cores diferentes: amarelo (pendentes), azul (horas)
        
        Variáveis de contexto:
        - candidatos_pendentes: Inscrições com status != "aprovado" e != "rejeitado"
        - horas_pendentes: Registros de horas com status != "validado"
    -->
    <div class="grid-dashboard stats">
        <!-- Alertas de Candidatos -->
        <div class="dashboard-card dashboard-stat-card vagas-abertas">
            <div class="card-title"><i class="fas fa-exclamation-triangle"></i> Candidatos Pendentes</div>
            <div class="dashboard-stat-number vagas">
                {{ candidatos_pendentes }}
            </div>
        </div>

        <!-- Alertas de Horas -->
        <div class="dashboard-card dashboard-stat-card inscricoes-ativas">
            <div class="card-title"><i class="fas fa-hourglass-half"></i> Horas Pendentes</div>
            <div class="dashboard-stat-number inscricoes">
                {{ horas_pendentes }}
            </div>
        </div>
    </div>

    <!-- 
        ====================================================================
        TABELA: ÚLTIMAS INSCRIÇÕES
        ====================================================================
        
        Mostra inscrições recentes com detalhes:
        - Candidato: Nome + Matrícula
        - Vaga: Disciplina/Nome da vaga
        - Data: Data e hora da inscrição
        - Status: Badge com status (Pendente/Aprovado/Rejeitado)
        
        Variável de contexto:
        - ultimas_inscricoes: QuerySet ordenado por -data_inscricao (DESC)
                             Limite: ~10 últimos registros
        
        Atributos esperados:
        - inscricao.aluno.nome
        - inscricao.aluno.matricula
        - inscricao.vaga.disciplina ou inscricao.vaga.nome (fallback)
        - inscricao.data_inscricao
        - inscricao.status (valor usado para classe CSS: status-{{ status|lower }})
    -->
    <div class="dashboard-card">
        <div class="card-title-with-icon">
            <i class="fas fa-list"></i>
            <span>Últimas Inscrições</span>
        </div>
        {% if ultimas_inscricoes %}
        <div class="table-responsive">
            <table class="table table-custom table-hover">
                <thead>
                    <tr>
                        <th>Candidato</th>
                        <th>Vaga</th>
                        <th>Data</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inscricao in ultimas_inscricoes %}
                    <tr>
                        <td>
                            <strong>{{ inscricao.aluno.nome }}</strong><br>
                            <small class="text-muted-custom">{{ inscricao.aluno.matricula }}</small>
                        </td>
                        <td>{{ inscricao.vaga.disciplina|default:inscricao.vaga.nome }}</td>
                        <td>{{ inscricao.data_inscricao|date:"d/m/Y H:i" }}</td>
                        <td>
                            <span class="status-badge status-{{ inscricao.status|lower }}">
                                {{ inscricao.status }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <!-- Estado vazio: Nenhuma inscrição para exibir -->
        <div class="dashboard-empty-state">
            <i class="fas fa-inbox"></i>
            <p>Nenhuma inscrição ainda</p>
        </div>
        {% endif %}
    </div>

    <!-- 
        ====================================================================
        SEÇÃO PARALELA: VAGAS POPULARES + TURMAS ATIVAS
        ====================================================================
        
        Grid com 2 cards lado a lado:
        1. Vagas Mais Procuradas: Ordenadas por numero_candidatos DESC
        2. Minhas Turmas Ativas: Turmas vinculadas ao professor com status=ativo
        
        Variáveis de contexto:
        - vagas_populares: QuerySet ordenado por -num_candidatos
        - minhas_turmas: QuerySet com turmas ativas do professor
    -->
    <div class="grid-dashboard content">
        <!-- Card: Vagas Mais Procuradas -->
        <div class="dashboard-card">
            <div class="card-title"><i class="fas fa-star"></i> Vagas Mais Procuradas</div>
            {% if vagas_populares %}
            <div>
                {% for vaga in vagas_populares %}
                <!-- Cada vaga em um stat-item para alinhamento consistente -->
                <div class="stat-item">
                    <div>
                        <strong>{{ vaga.disciplina|default:vaga.nome }}</strong><br>
                        <small class="text-muted-custom">Curso: {{ vaga.curso.nome }}</small>
                    </div>
                    <!-- Badge com número de candidatos -->
                    <span class="info-badge">{{ vaga.num_candidatos }} cand.</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Estado vazio: Nenhuma vaga ativa -->
            <div class="dashboard-empty-state">
                <p>Nenhuma vaga ativa</p>
            </div>
            {% endif %}
        </div>

        <!-- Card: Minhas Turmas Ativas -->
        <div class="dashboard-card">
            <div class="card-title"><i class="fas fa-book"></i> Minhas Turmas Ativas</div>
            {% if minhas_turmas %}
            <div>
                {% for turma in minhas_turmas %}
                <!-- Cada turma em um stat-item -->
                <div class="stat-item">
                    <div>
                        <strong>{{ turma.disciplina }}</strong><br>
                        <small class="text-muted-custom">{{ turma.horario }}</small>
                    </div>
                    <!-- Badge com semestre/período -->
                    <span class="turma-status-badge">
                        {{ turma.semestre }}
                    </span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Estado vazio: Nenhuma turma ativa -->
            <div class="dashboard-empty-state">
                <p>Nenhuma turma ativa</p>
            </div>
            {% endif %}
        </div>
    </div>

    {% else %}
    <!-- 
        ====================================================================
        DASHBOARD ADMIN / GERAL
        ====================================================================
        
        Conteúdo de nível administrativo/gestão
        Visão global do sistema com todas as métricas
        
        Permissão: is_professor_dashboard == False (user.is_admin ou is_staff)
        
        KPIs Exibidos:
        1. Total de Usuários: Contagem de User registrados
        2. Total de Alunos: Contagem de Aluno registrados
        3. Turmas Ativas: Contagem de Turma com status=ativo
        4. Vagas Ativas: Contagem de Vaga com status=aberta ou similar
        
        Tabelas:
        1. Últimas Monitorias: Últimas monitorias criadas
        2. Inscrições Pendentes: Inscrições aguardando avaliação
    -->

    <!-- Cabeçalho da página -->
    <div class="dashboard-header">
        <h1>
            <i class="fas fa-tachometer-alt"></i> Dashboard Geral
        </h1>
        <p>
            <small><i class="fas fa-clock"></i> Visão geral do sistema</small>
        </p>
    </div>

    <!-- 
        ====================================================================
        KPIs GLOBAIS - GRID 4 COLUNAS
        ====================================================================
        
        Métricas de nível administrativo
        
        Variáveis de contexto:
        - total_usuarios: COUNT(*) de User
        - total_alunos: COUNT(*) de Aluno
        - total_turmas: COUNT(*) de Turma com status=ativo
        - total_vagas: COUNT(*) de Vaga abertas
    -->
    <div class="grid-dashboard">
        <!-- Card 1: Total de Usuários -->
        <div class="dashboard-card">
            <div class="stat-item">
                <div>
                    <div class="stat-label">Total de Usuários</div>
                    <div class="stat-number">{{ total_usuarios }}</div>
                </div>
                <div class="icon-stat"><i class="fas fa-users"></i></div>
            </div>
        </div>

        <!-- Card 2: Total de Alunos -->
        <div class="dashboard-card">
            <div class="stat-item">
                <div>
                    <div class="stat-label">Total de Alunos</div>
                    <div class="stat-number">{{ total_alunos }}</div>
                </div>
                <div class="icon-stat"><i class="fas fa-user-graduate"></i></div>
            </div>
        </div>

        <!-- Card 3: Turmas Ativas -->
        <div class="dashboard-card">
            <div class="stat-item">
                <div>
                    <div class="stat-label">Turmas Ativas</div>
                    <div class="stat-number">{{ total_turmas }}</div>
                </div>
                <div class="icon-stat"><i class="fas fa-book"></i></div>
            </div>
        </div>

        <!-- Card 4: Vagas Ativas -->
        <div class="dashboard-card">
            <div class="stat-item">
                <div>
                    <div class="stat-label">Vagas Ativas</div>
                    <div class="stat-number">{{ total_vagas }}</div>
                </div>
                <div class="icon-stat"><i class="fas fa-briefcase"></i></div>
            </div>
        </div>
    </div>

    <!-- 
        ====================================================================
        TABELA: ÚLTIMAS MONITORIAS
        ====================================================================
        
        Mostra monitorias criadas recentemente com status
        
        Variável de contexto:
        - ultimas_monitorias: QuerySet ordenado por -data_criacao
                             Limite: ~10 últimos registros
        
        Atributos esperados:
        - monitoria.disciplina
        - monitoria.semestre
        - monitoria.horario
        - monitoria.ativo (boolean: campo para status ativo/inativo)
    -->
    <div class="dashboard-card">
        <div class="card-title"><i class="fas fa-list"></i> Últimas Monitorias Cadastradas</div>
        {% if ultimas_monitorias %}
        <div class="table-responsive">
            <table class="table table-custom table-hover">
                <thead>
                    <tr>
                        <th>Disciplina</th>
                        <th>Semestre</th>
                        <th>Horário</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for monitoria in ultimas_monitorias %}
                    <tr>
                        <td><strong>{{ monitoria.disciplina }}</strong></td>
                        <td>{{ monitoria.semestre }}</td>
                        <td>{{ monitoria.horario }}</td>
                        <td>
                            <!-- Renderização condicional de status -->
                            {% if monitoria.ativo %}
                            <span class="status-badge status-aprovado">Ativa</span>
                            {% else %}
                            <span class="status-badge status-rejeitado">Inativa</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <!-- Estado vazio: Nenhuma monitoria registrada -->
        <div class="empty-state">
            <p>Nenhuma monitoria registrada</p>
        </div>
        {% endif %}
    </div>

    <!-- 
        ====================================================================
        TABELA: INSCRIÇÕES PENDENTES
        ====================================================================
        
        Inscrições aguardando avaliação/análise
        
        Variável de contexto:
        - inscricoes_pendentes: QuerySet filtrado por status="Pendente"
                               Ordenado por -data_inscricao
        
        Atributos esperados:
        - inscricao.aluno.nome
        - inscricao.vaga.disciplina ou inscricao.vaga.nome
        - inscricao.data_inscricao
    -->
    <div class="dashboard-card">
        <div class="card-title"><i class="fas fa-hourglass-half"></i> Inscrições Pendentes</div>
        {% if inscricoes_pendentes %}
        <div class="table-responsive">
            <table class="table table-custom table-hover">
                <thead>
                    <tr>
                        <th>Candidato</th>
                        <th>Vaga</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inscricao in inscricoes_pendentes %}
                    <tr>
                        <td><strong>{{ inscricao.aluno.nome }}</strong></td>
                        <td>{{ inscricao.vaga.disciplina|default:inscricao.vaga.nome }}</td>
                        <td>{{ inscricao.data_inscricao|date:"d/m/Y" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <!-- Estado vazio: Nenhuma inscrição pendente -->
        <div class="empty-state">
            <p>Nenhuma inscrição pendente</p>
        </div>
        {% endif %}
    </div>

    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
    // ========== THEME TOGGLE ==========
    // Load theme before DOM to prevent flash
    (function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.body.setAttribute('data-theme', savedTheme);
    })();
    
    function toggleTheme() {
        const html = document.documentElement;
        const body = document.body;
        const currentTheme = html.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        html.setAttribute('data-theme', newTheme);
        body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        
        // Update icon
        const icon = document.querySelector('.theme-toggle i');
        icon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        
        // Força atualização visual
        forceThemeUpdate(newTheme);
    }
    
    function forceThemeUpdate(theme) {
        // Define cores baseadas no tema
        const colors = {
            dark: {
                cardBg: '#2a2a2a',
                border: '#3a3a3a',
                textPrimary: '#e0e0e0',
                textSecondary: '#b0b0b0',
                bgSecondary: '#1e1e1e'
            },
            light: {
                cardBg: '#ffffff',
                border: '#e0e6ef',
                textPrimary: '#002555',
                textSecondary: '#6c757d',
                bgSecondary: '#f8fafc'
            }
        };
        
        const currentColors = colors[theme];
        
        // Força todos os cards a respeitarem o tema
        const cards = document.querySelectorAll('.dashboard-card, .content-card');
        cards.forEach(card => {
            card.style.backgroundColor = currentColors.cardBg;
            card.style.borderColor = currentColors.border;
        });
        
        // Força todas as tabelas
        const tables = document.querySelectorAll('.table-custom');
        tables.forEach(table => {
            table.style.color = currentColors.textPrimary;
        });
        
        // Força thead
        const theads = document.querySelectorAll('.table-custom thead');
        theads.forEach(thead => {
            thead.style.backgroundColor = currentColors.bgSecondary;
        });
        
        // Força th
        const ths = document.querySelectorAll('.table-custom th');
        ths.forEach(th => {
            th.style.color = currentColors.textSecondary;
            th.style.borderColor = currentColors.border;
        });
        
        // Força td
        const tds = document.querySelectorAll('.table-custom td');
        tds.forEach(td => {
            td.style.color = currentColors.textPrimary;
            td.style.borderColor = currentColors.border;
            td.style.background = 'transparent';
        });
        
        // Força todos os textos
        const textElements = document.querySelectorAll('.card-title, .card-title-with-icon, .stat-label, .stat-number');
        textElements.forEach(el => {
            if (el.classList.contains('stat-label')) {
                el.style.color = currentColors.textSecondary;
            } else {
                el.style.color = currentColors.textPrimary;
            }
        });
        
        // Força stat-items
        const statItems = document.querySelectorAll('.stat-item');
        statItems.forEach(item => {
            item.style.background = 'transparent';
            item.style.borderColor = currentColors.border;
        });
        
        // Força strong e small
        const strongs = document.querySelectorAll('.dashboard-card strong, .table-custom strong');
        strongs.forEach(strong => {
            strong.style.color = currentColors.textPrimary;
        });
        
        const smalls = document.querySelectorAll('.dashboard-card small, .table-custom small, .text-muted-custom');
        smalls.forEach(small => {
            small.style.color = currentColors.textSecondary;
        });
    }
    
    // Set correct icon on load
    window.addEventListener('DOMContentLoaded', function() {
        const currentTheme = localStorage.getItem('theme') || 'light';
        const icon = document.querySelector('.theme-toggle i');
        icon.className = currentTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        
        // Aplica tema ao carregar
        forceThemeUpdate(currentTheme);
    });
    
    console.log('Dashboard carregado com sucesso');
</script>
{% endblock %}