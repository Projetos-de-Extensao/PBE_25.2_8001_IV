{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard de Gestão - Plataforma Casa{% endblock %}

{% block extra_css %}
<style>
    /* ===== DESKTOP - Layout Compacto ===== */
    .dashboard-container { 
        padding: 1.5rem 0; 
        max-width: 1400px; 
        margin: 0 auto;
    }
    
    /* KPI Cards - Compactos */
    .kpi-card { 
        background: white; 
        border-radius: 8px; 
        padding: 1rem; 
        box-shadow: 0 2px 4px rgba(0, 37, 85, 0.08); 
        border-left: 3px solid; 
        transition: all 0.2s ease;
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .kpi-card:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 4px 8px rgba(0, 37, 85, 0.12); 
    }
    .kpi-card.primary { border-left-color: #002555; }
    .kpi-card.success { border-left-color: #28a745; }
    .kpi-card.info { border-left-color: #1245FF; }
    .kpi-card.warning { border-left-color: #F5AC00; }
    
    .kpi-number { 
        font-size: 1.75rem; 
        font-weight: 700; 
        color: #002555; 
        margin: 0.25rem 0; 
        line-height: 1.2;
    }
    .kpi-label { 
        font-size: 0.75rem; 
        color: #6c757d; 
        font-weight: 600; 
        text-transform: uppercase; 
        letter-spacing: 0.3px;
        line-height: 1.3;
    }
    .kpi-icon { 
        font-size: 1.5rem; 
        color: #e0e0e0; 
        float: right; 
        margin-top: -0.5rem;
    }
    
    /* Chart Cards - Compactos */
    .chart-card { 
        background: white; 
        border-radius: 8px; 
        padding: 1rem; 
        box-shadow: 0 2px 4px rgba(0, 37, 85, 0.08); 
        margin-bottom: 1.25rem; 
    }
    .chart-title { 
        font-size: 0.9375rem; 
        font-weight: 600; 
        color: #002555; 
        margin-bottom: 1rem; 
        padding-bottom: 0.75rem; 
        border-bottom: 1px solid #f0f0f0; 
    }
    .chart-container { 
        position: relative; 
        height: 250px; 
        margin-bottom: 0.5rem; 
    }
    .chart-container-large { 
        position: relative; 
        height: 300px; 
        margin-bottom: 0.5rem; 
    }
    
    /* Alert Cards - Compactos */
    .alert-card { 
        background: white; 
        border-radius: 8px; 
        padding: 0.875rem; 
        box-shadow: 0 2px 4px rgba(0, 37, 85, 0.08); 
        margin-bottom: 1rem; 
        border-left: 3px solid #dc3545; 
        min-height: 85px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .alert-title { 
        font-size: 0.75rem; 
        font-weight: 600; 
        color: #002555; 
        margin-bottom: 0.25rem; 
        text-transform: uppercase;
        line-height: 1.3;
    }
    .alert-count { 
        font-size: 1.5rem; 
        font-weight: 700; 
        color: #dc3545; 
        line-height: 1.2;
    }
    
    /* Header - Compacto */
    .header-section { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 1.5rem; 
        flex-wrap: wrap; 
        gap: 1rem; 
    }
    .header-info h1 { 
        font-size: 3rem; /* Aumentado ainda mais no desktop */
        color: #002555; 
        margin: 0; 
        font-weight: 700; 
        line-height: 1.2;
    }
    .header-info p { 
        color: #6c757d; 
        margin: 0.25rem 0 0 0; 
        font-size: 0.875rem;
    }
    .header-info small {
        font-size: 0.75rem;
        color: #999;
    }
    .export-buttons { 
        display: flex; 
        gap: 0.375rem; 
        flex-wrap: wrap; 
    }
    .btn-export { 
        background: transparent; 
        border: 2px solid #1245FF; 
        color: #1245FF; 
        font-weight: 500; 
        padding: 0.5rem 1rem; 
        transition: all 0.2s ease; 
        font-size: 0.8125rem;
        border-radius: 6px;
    }
    .btn-export:hover { 
        background-color: #1245FF; 
        color: white; 
    }
    
    /* Grids Compactos */
    .grid-2 { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
        gap: 1rem; 
        margin-bottom: 1.25rem; 
    }
    .grid-3 { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
        gap: 1rem; 
        margin-bottom: 1.25rem; 
    }
    .grid-4 { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 1rem; 
        margin-bottom: 1.25rem; 
    }
    
    /* ===== MOBILE - Layout Super Compacto ===== */
    @media (max-width: 768px) {
        .dashboard-container { 
            padding: 0.5rem 0 0 0; 
        }
        /* Garante espaçamento do topo para o header não sumir atrás do navbar */
        .header-section {
            padding-top: 2.5rem;
        }
        
        /* Header Mobile - CORRIGIDO para não vazar */
        .header-section { 
            flex-direction: column; 
            align-items: flex-start; 
            margin-bottom: 1rem;
            gap: 0.75rem;
            width: 100%;
            overflow: hidden;
            background: white;
            z-index: 10;
            position: relative;
        }
        .header-info {
            width: 100%;
            overflow: hidden;
            display: block;
        }
        .header-info h1 {
            display: block;
            font-size: 1.5rem !important; /* Tamanho otimizado para mobile */
            font-weight: 700;
            color: #002555;
            margin: 0 !important;
            padding: 0 !important;
            line-height: 1.25 !important;
            overflow-wrap: break-word;
            word-wrap: break-word;
            hyphens: auto;
            background: white;
            z-index: 11;
            max-width: 100vw;
            white-space: normal;
        }
        .header-info h1 i {
            font-size: 0.75rem !important;
            margin-right: 0.375rem;
        }
        .header-info p { 
            font-size: 0.6875rem !important; /* Reduzido */
            margin: 0.25rem 0 0 0 !important;
            line-height: 1.3 !important;
            overflow-wrap: break-word;
        }
        .header-info small {
            font-size: 0.625rem !important; /* Reduzido */
            display: block;
            margin-top: 0.25rem;
        }
        
        /* Export buttons mobile */
        .export-buttons { 
            width: 100%; 
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.375rem;
        }
        .btn-export { 
            padding: 0.5rem 0.5rem; 
            font-size: 0.75rem;
            text-align: center;
        }
        .btn-export i {
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }
        
        /* KPI Cards - MUITO Compactos */
        .kpi-card { 
            padding: 0.625rem; 
            border-radius: 6px;
            min-height: 80px;
        }
        .kpi-number { 
            font-size: 1.375rem; 
            margin: 0.125rem 0;
        }
        .kpi-label { 
            font-size: 0.6875rem; 
            line-height: 1.2;
        }
        .kpi-icon { 
            font-size: 1.125rem; 
            margin-top: -0.25rem;
        }
        
        /* Alert Cards Mobile */
        .alert-card { 
            padding: 0.625rem; 
            min-height: 70px;
            margin-bottom: 0.75rem;
        }
        .alert-title { 
            font-size: 0.6875rem; 
        }
        .alert-title i {
            font-size: 0.6875rem;
        }
        .alert-count { 
            font-size: 1.25rem; 
        }
        
        /* Charts Mobile - CORRIGIDO legendas e sobreposição */
        .chart-card { 
            padding: 0.75rem; 
            margin-bottom: 1rem;
            border-radius: 6px;
            overflow: hidden;
            width: 100%;
        }
        .chart-title { 
            font-size: 0.8125rem !important; /* Reduzido */
            margin-bottom: 0.625rem !important;
            padding-bottom: 0.5rem;
            line-height: 1.2 !important;
            overflow-wrap: break-word;
        }
        .chart-title i {
            font-size: 0.75rem !important;
        }
        .chart-container { 
            height: 220px !important; /* Aumentado para caber legendas */
            width: 100% !important;
            position: relative;
            overflow: visible;
        }
        .chart-container canvas {
            max-width: 100% !important;
            height: auto !important;
        }
        .chart-container-large { 
            height: 280px !important; /* Altura otimizada para mobile */
            width: 100% !important;
            position: relative;
            overflow: visible;
            margin-bottom: 0 !important;
        }
        .chart-container-large canvas {
            max-width: 100% !important;
            height: 100% !important;
        }
        
        /* Grids Mobile - 2 colunas para KPIs */
        .grid-2 { 
            grid-template-columns: 1fr !important; 
            gap: 0.75rem; 
            margin-bottom: 1rem;
        }
        .grid-3 { 
            grid-template-columns: 1fr !important; 
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .grid-3[style*="minmax"] {
            grid-template-columns: 1fr !important;
        }
        .grid-4 { 
            grid-template-columns: repeat(2, 1fr); 
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        /* Análise Financeira Mobile */
        .chart-card > div[style*="grid"] {
            grid-template-columns: 1fr !important;
            gap: 0.5rem !important;
        }
        .chart-card > div[style*="grid"] > div {
            padding: 0.625rem !important;
        }
        .chart-card > div[style*="grid"] small {
            font-size: 0.6875rem !important;
        }
        .chart-card > div[style*="grid"] div[style*="1.75rem"] {
            font-size: 1.25rem !important;
        }
        
        /* Ajustes gerais de espaçamento mobile */
        .container-fluid {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
            overflow-x: hidden !important;
        }
        
        /* Garantir que nada vaze da tela */
        body {
            overflow-x: hidden !important;
        }
        
        * {
            max-width: 100% !important;
        }
        
        /* Legendas dos gráficos - compactar ainda mais em mobile */
        canvas {
            max-height: 180px !important;
        }
        
        /* Títulos das páginas - ajuste para mobile */
        .page-title, .page-header {
            padding-top: 2.5rem;
        }
        .page-title h1, .page-header h1 {
            font-size: 1.25rem;
        }
    }
    
    /* ===== TABLET (576px - 768px) ===== */
    @media (min-width: 576px) and (max-width: 768px) {
        .grid-2 { 
            grid-template-columns: repeat(3, 1fr); 
        }
        .grid-4 { 
            grid-template-columns: repeat(3, 1fr); 
        }
        .export-buttons {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid dashboard-container">
    <div class="header-section">
        <div class="header-info">
            <h1><i class="fas fa-chart-line"></i> Dashboard de Gestão</h1>
            <p>Painel de controle completo do programa de monitoria</p>
            <small><i class="fas fa-clock"></i> Atualizado em: {{ now|date:"d/m/Y H:i" }}</small>
        </div>
        <div class="export-buttons">
            <button type="button" class="btn btn-export" onclick="exportarExcel()"><i class="fas fa-file-excel"></i> Excel</button>
            <button type="button" class="btn btn-export" onclick="exportarPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
            <button type="button" class="btn btn-export" onclick="window.print()"><i class="fas fa-print"></i> Imprimir</button>
        </div>
    </div>

    <div class="grid-4">
        <div class="kpi-card primary">
            <div class="kpi-icon"><i class="fas fa-user-graduate"></i></div>
            <div class="kpi-label">Monitores Ativos</div>
            <div class="kpi-number">{{ total_monitores }}</div>
        </div>
        <div class="kpi-card success">
            <div class="kpi-icon"><i class="fas fa-users"></i></div>
            <div class="kpi-label">Total de Alunos</div>
            <div class="kpi-number">{{ total_alunos }}</div>
        </div>
        <div class="kpi-card info">
            <div class="kpi-icon"><i class="fas fa-briefcase"></i></div>
            <div class="kpi-label">Vagas Ativas</div>
            <div class="kpi-number">{{ total_vagas }}</div>
        </div>
        <div class="kpi-card warning">
            <div class="kpi-icon"><i class="fas fa-percentage"></i></div>
            <div class="kpi-label">Taxa de Aprovação</div>
            <div class="kpi-number">{{ taxa_aprovacao }}%</div>
        </div>
    </div>

    <div class="grid-4">
        <div class="kpi-card primary">
            <div class="kpi-icon"><i class="fas fa-clock"></i></div>
            <div class="kpi-label">Horas no Mês</div>
            <div class="kpi-number">{{ total_horas_mes }}</div>
        </div>
        <div class="kpi-card success">
            <div class="kpi-icon"><i class="fas fa-dollar-sign"></i></div>
            <div class="kpi-label">Pagamentos do Mês</div>
            <div class="kpi-number">R$ {{ valor_total_mes }}</div>
        </div>
        <div class="kpi-card info">
            <div class="kpi-icon"><i class="fas fa-book"></i></div>
            <div class="kpi-label">Monitorias Ativas</div>
            <div class="kpi-number">{{ total_turmas }}</div>
        </div>
        <div class="kpi-card warning">
            <div class="kpi-icon"><i class="fas fa-chalkboard-teacher"></i></div>
            <div class="kpi-label">Total de Inscrições</div>
            <div class="kpi-number">{{ total_inscricoes }}</div>
        </div>
    </div>

    <div class="grid-4">
        <div class="alert-card">
            <div class="alert-title"><i class="fas fa-exclamation-triangle"></i> Pagamentos Pendentes</div>
            <div class="alert-count">{{ pagamentos_pendentes }}</div>
        </div>
        <div class="alert-card">
            <div class="alert-title"><i class="fas fa-clock"></i> Avaliações Pendentes</div>
            <div class="alert-count">{{ avaliacoes_pendentes }}</div>
        </div>
        <div class="alert-card">
            <div class="alert-title"><i class="fas fa-hourglass-half"></i> Horas Pendentes</div>
            <div class="alert-count">{{ horas_pendentes }}</div>
        </div>
        <div class="alert-card">
            <div class="alert-title"><i class="fas fa-file"></i> Documentos Pendentes</div>
            <div class="alert-count">{{ documentos_pendentes }}</div>
        </div>
    </div>

    <div class="grid-3" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));">
        <div class="chart-card">
            <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Status de Inscrições</h3>
            <div class="chart-container"><canvas id="chartInscricoes"></canvas></div>
        </div>
        <div class="chart-card">
            <h3 class="chart-title"><i class="fas fa-chart-doughnut"></i> Monitores por Curso</h3>
            <div class="chart-container"><canvas id="chartCursos"></canvas></div>
        </div>
        <div class="chart-card">
            <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Status de Horas</h3>
            <div class="chart-container"><canvas id="chartHorasStatus"></canvas></div>
        </div>
    </div>

    <div class="grid-2">
        <div class="chart-card">
            <h3 class="chart-title"><i class="fas fa-chart-line"></i> Evolução de Inscrições (6 meses)</h3>
            <div class="chart-container-large"><canvas id="chartTimelineInscricoes"></canvas></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>

<script>
const CORES = { 
    primario: '#002555', 
    secundo: '#1245FF', 
    amarelo: '#F5AC00', 
    sucesso: '#28a745', 
    perigo: '#dc3545', 
    cinza: '#6c757d',
    info: '#17a2b8'
};

// Detectar se é mobile
const isMobile = window.innerWidth <= 768;

// 1️⃣ Status de Inscrições - Doughnut interativo com suporte mobile
new Chart(document.getElementById('chartInscricoes').getContext('2d'), {
    type: 'doughnut',
    data: { 
        labels: {{ status_labels|safe }}, 
        datasets: [{ 
            data: {{ status_values|safe }}, 
            backgroundColor: [CORES.sucesso, CORES.amarelo, CORES.perigo, CORES.cinza],
            borderColor: 'white', 
            borderWidth: isMobile ? 1 : 2,
            hoverOffset: isMobile ? 5 : 10
        }] 
    },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        interaction: { mode: 'point', intersect: false },
        layout: {
            padding: isMobile ? 5 : 10
        },
        plugins: { 
            legend: { 
                position: 'bottom',
                align: 'start',
                labels: { 
                    font: { size: isMobile ? 9 : 11 }, 
                    padding: isMobile ? 8 : 15, 
                    usePointStyle: true,
                    boxWidth: isMobile ? 8 : 12,
                    boxHeight: isMobile ? 8 : 12
                }
            },
            tooltip: { 
                enabled: !isMobile, // Desabilitar tooltip em mobile para evitar sobreposição
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleFont: { size: 12 },
                bodyFont: { size: 11 },
                padding: 12,
                displayColors: true
            }
        }
    }
});

// 2️⃣ Monitores por Curso - Doughnut interativo com cores variadas e suporte mobile
new Chart(document.getElementById('chartCursos').getContext('2d'), {
    type: 'doughnut',
    data: { 
        labels: {{ curso_labels|safe }}, 
        datasets: [{ 
            data: {{ curso_values|safe }}, 
            backgroundColor: [CORES.primario, CORES.secundo, CORES.amarelo, CORES.sucesso, CORES.info, '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7'],
            borderColor: 'white', 
            borderWidth: isMobile ? 1 : 2,
            hoverOffset: isMobile ? 5 : 10
        }] 
    },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        interaction: { mode: 'point', intersect: false },
        layout: {
            padding: isMobile ? 5 : 10
        },
        plugins: { 
            legend: { 
                position: 'bottom',
                align: 'start',
                labels: { 
                    font: { size: isMobile ? 9 : 11 }, 
                    padding: isMobile ? 8 : 15, 
                    usePointStyle: true,
                    boxWidth: isMobile ? 8 : 12,
                    boxHeight: isMobile ? 8 : 12
                }
            },
            tooltip: { 
                enabled: !isMobile, // Desabilitar tooltip em mobile
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleFont: { size: 12 },
                bodyFont: { size: 11 },
                padding: 12,
                displayColors: true
            }
        }
    }
});

// 3️⃣ Status de Horas - Horizontal Bar com interatividade e suporte mobile
new Chart(document.getElementById('chartHorasStatus').getContext('2d'), {
    type: 'bar',
    data: { 
        labels: {{ horas_status_labels|safe }}, 
        datasets: [{ 
            label: 'Quantidade de Horas',
            data: {{ horas_status_values|safe }}, 
            backgroundColor: [CORES.sucesso, CORES.amarelo, CORES.perigo, CORES.cinza],
            borderColor: 'rgba(0,0,0,0.1)',
            borderWidth: 1,
            hoverBackgroundColor: [CORES.sucesso, CORES.amarelo, CORES.perigo, CORES.cinza],
            hoverBorderWidth: 2,
            hoverBorderColor: '#000'
        }] 
    },
    options: { 
        indexAxis: 'y', 
        responsive: true, 
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        layout: {
            padding: isMobile ? 5 : 10
        },
        plugins: { 
            legend: { 
                display: !isMobile, // Ocultar legenda em mobile para economizar espaço
                labels: { 
                    padding: 15,
                    font: { size: isMobile ? 9 : 11 }
                } 
            },
            tooltip: { 
                enabled: !isMobile, // Desabilitar tooltip em mobile
                backgroundColor: 'rgba(0,0,0,0.8)',
                padding: 12,
                titleFont: { size: 12 },
                bodyFont: { size: 11 }
            }
        },
        scales: { 
            x: { 
                beginAtZero: true, 
                ticks: { 
                    callback: function(v){ return v.toLocaleString('pt-BR'); },
                    font: { size: isMobile ? 9 : 11 }
                } 
            },
            y: {
                ticks: {
                    font: { size: isMobile ? 9 : 11 }
                }
            }
        }
    }
});

// 4️⃣ Evolução de Inscrições - Line chart com area e animação com suporte mobile
new Chart(document.getElementById('chartTimelineInscricoes').getContext('2d'), {
    type: 'line',
    data: { 
        labels: {{ timeline_labels|safe }}, 
        datasets: [{ 
            label: 'Inscrições Acumuladas',
            data: {{ timeline_values|safe }}, 
            borderColor: CORES.secundo, 
            backgroundColor: 'rgba(18, 69, 255, 0.1)', 
            borderWidth: isMobile ? 2 : 3, 
            tension: 0.4, 
            fill: true, 
            pointRadius: isMobile ? 3 : 6,
            pointBackgroundColor: CORES.secundo,
            pointBorderColor: 'white',
            pointBorderWidth: isMobile ? 1 : 2,
            hoverPointRadius: isMobile ? 5 : 8,
            pointHoverBackgroundColor: CORES.amarelo
        }] 
    },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        layout: {
            padding: {
                top: isMobile ? 5 : 10,
                bottom: isMobile ? 5 : 10,
                left: isMobile ? 5 : 10,
                right: isMobile ? 5 : 10
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top',
                align: 'start',
                labels: {
                    font: { size: isMobile ? 10 : 11 },
                    padding: isMobile ? 8 : 15,
                    usePointStyle: true,
                    boxWidth: isMobile ? 10 : 12,
                    boxHeight: isMobile ? 10 : 12
                }
            },
            tooltip: { 
                enabled: true,
                backgroundColor: 'rgba(0,0,0,0.8)',
                padding: isMobile ? 8 : 12,
                titleFont: { size: isMobile ? 10 : 12 },
                bodyFont: { size: isMobile ? 9 : 11 },
                callbacks: {
                    label: function(ctx) { return 'Inscrições: ' + ctx.parsed.y.toLocaleString('pt-BR'); }
                }
            }
        },
        scales: { 
            y: { 
                beginAtZero: true,
                grace: '5%',
                ticks: { 
                    callback: function(v){ return v.toLocaleString('pt-BR'); },
                    font: { size: isMobile ? 9 : 11 },
                    maxTicksLimit: isMobile ? 5 : 8,
                    padding: isMobile ? 5 : 5
                },
                grid: {
                    display: true,
                    drawBorder: true,
                    color: 'rgba(0,0,0,0.05)'
                }
            },
            x: {
                ticks: {
                    font: { size: isMobile ? 8 : 11 },
                    maxRotation: isMobile ? 45 : 0,
                    minRotation: isMobile ? 45 : 0,
                    autoSkip: true,
                    maxTicksLimit: isMobile ? 6 : 12,
                    padding: isMobile ? 5 : 5
                },
                grid: {
                    display: false
                }
            }
        }
    }
});

function exportarExcel() {
    const wb = XLSX.utils.book_new();
    const wsData = [
        ['DASHBOARD DE GESTÃO - PLATAFORMA CASA'],
        ['Relatório Gerado:', new Date().toLocaleString('pt-BR')],
        [],
        ['INDICADORES PRINCIPAIS'],
        ['Monitores Ativos', {{ total_monitores }}],
        ['Total de Alunos', {{ total_alunos }}],
        ['Vagas Ativas', {{ total_vagas }}],
        ['Taxa de Aprovação', '{{ taxa_aprovacao }}%'],
        [],
        ['ESTATÍSTICAS MENSAIS'],
        ['Horas Trabalhadas', {{ total_horas_mes }}],
        ['Valor de Pagamentos', 'R$ {{ valor_total_mes }}'],
        ['Monitorias Ativas', {{ total_turmas }}],
        ['Total de Inscrições', {{ total_inscricoes }}],
        [],
        ['PENDÊNCIAS'],
        ['Pagamentos Pendentes', {{ pagamentos_pendentes }}],
        ['Avaliações Pendentes', {{ avaliacoes_pendentes }}],
        ['Horas Pendentes', {{ horas_pendentes }}],
        ['Documentos Pendentes', {{ documentos_pendentes }}],
        [],
        ['ANÁLISE FINANCEIRA'],
        ['Total Pago (Ano)', 'R$ {{ total_pago_ano }}'],
        ['Média Mensal', 'R$ {{ media_mensal }}'],
        ['CR Médio', {{ cr_medio_monitores }}],
        ['Horas/Monitor', '{{ media_horas_monitor }}h']
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    ws['!cols'] = [{ wch: 25 }, { wch: 15 }];
    XLSX.utils.book_append_sheet(wb, ws, 'Dashboard');
    XLSX.writeFile(wb, `dashboard-gestao-{{ now|date:"Y-m-d-His" }}.xlsx`);
}

function exportarPDF() {
    const element = document.querySelector('.dashboard-container');
    const opt = {
        margin: 10,
        filename: `dashboard-gestao-{{ now|date:"Y-m-d-His" }}.pdf`,
        image: { type: 'png', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    };
    
    html2canvas(element).then(canvas => {
        const { jsPDF } = window.jspdf;
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 190;
        const pageHeight = 277;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        let heightLeft = imgHeight;
        let position = 0;
        
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        pdf.save(opt.filename);
    }).catch(err => alert('Erro ao gerar PDF: ' + err));
}

</script>
{% endblock %}
